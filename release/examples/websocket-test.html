<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Middleware WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        input, textarea, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔌 POS Middleware WebSocket Test Client</h1>
        
        <div class="section">
            <h3>Connection Settings</h3>
            <input type="text" id="wsUrl" value="ws://localhost:8081" placeholder="WebSocket URL">
            <input type="text" id="apiKey" value="test-api-key-123" placeholder="API Key">
            <button onclick="connect()" id="connectBtn">Connect</button>
            <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
            <div id="status" class="status disconnected">Disconnected</div>
        </div>

        <div class="section">
            <h3>Send Order Update</h3>
            <input type="text" id="orderId" value="ORD-001" placeholder="Order ID">
            <select id="orderStatus">
                <option value="new">New</option>
                <option value="confirmed">Confirmed</option>
                <option value="preparing">Preparing</option>
                <option value="ready">Ready</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
            <button onclick="sendOrderUpdate()" id="sendOrderBtn" disabled>Send Order Status Update</button>
        </div>

        <div class="section">
            <h3>Send Lucrum Sales Order</h3>
            <textarea id="salesOrderData" rows="15" placeholder="Lucrum Sales Order JSON data...">{
  "name": "SO25-TEST-001",
  "customer": "Walk In",
  "customer_name": "Test Customer",
  "branch": "Test Branch",
  "table_no": "1",
  "transaction_date": "2025-09-18",
  "total_qty": 1,
  "base_total": 150,
  "total": 150,
  "base_grand_total": 150,
  "grand_total": 150,
  "rounded_total": 150,
  "status": "To Deliver and Bill",
  "kds_status": "New",
  "resturent_type": "Dine-In",
  "items": [
    {
      "name": "test_item_1",
      "idx": 1,
      "item_code": "TEST-BURGER",
      "item_name": "Test Burger",
      "qty": 1,
      "rate": 150,
      "amount": 150,
      "is_kds_item": 1,
      "parent": "SO25-TEST-001"
    }
  ]
}</textarea>
            <button onclick="sendSalesOrder()" id="sendSalesOrderBtn" disabled>Send Lucrum Sales Order</button>
        </div>

        <div class="section">
            <h3>Send KDS Status Update</h3>
            <input type="text" id="kdsOrderName" value="SO25-TEST-001" placeholder="Order Name">
            <input type="text" id="kdsStation" value="BAR" placeholder="KDS Station">
            <select id="kdsStatus">
                <option value="New">New</option>
                <option value="Preparing">Preparing</option>
                <option value="Cooking">Cooking</option>
                <option value="Cooked">Cooked</option>
                <option value="Ready">Ready</option>
                <option value="Served">Served</option>
            </select>
            <button onclick="sendKDSUpdate()" id="sendKDSBtn" disabled>Send KDS Status Update</button>
        </div>

        <div class="section">
            <h3>Send Legacy Order (Backward Compatibility)</h3>
            <textarea id="orderData" rows="8" placeholder="Legacy Order JSON data...">{
  "order_id": "ORD-002",
  "source_client_id": "WEBSOCKET-TEST",
  "customer_name": "WebSocket Customer",
  "total_amount": 19.99,
  "items": [
    {
      "name": "Test Item",
      "price": 19.99,
      "quantity": 1,
      "notes": "Test order from WebSocket"
    }
  ]
}</textarea>
            <button onclick="sendNewOrder()" id="sendNewOrderBtn" disabled>Send Legacy Order</button>
        </div>

        <div class="section">
            <h3>Activity Log</h3>
            <button onclick="clearLog()">Clear Log</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let isConnected = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateUI() {
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendOrderBtn = document.getElementById('sendOrderBtn');
            const sendSalesOrderBtn = document.getElementById('sendSalesOrderBtn');
            const sendKDSBtn = document.getElementById('sendKDSBtn');
            const sendNewOrderBtn = document.getElementById('sendNewOrderBtn');
            const status = document.getElementById('status');

            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            sendOrderBtn.disabled = !isConnected;
            sendSalesOrderBtn.disabled = !isConnected;
            sendKDSBtn.disabled = !isConnected;
            sendNewOrderBtn.disabled = !isConnected;

            if (isConnected) {
                status.className = 'status connected';
                status.textContent = 'Connected ✅';
            } else {
                status.className = 'status disconnected';
                status.textContent = 'Disconnected ❌';
            }
        }

        function connect() {
            const wsUrl = document.getElementById('wsUrl').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!wsUrl || !apiKey) {
                alert('Please enter WebSocket URL and API Key');
                return;
            }

            log('Attempting to connect to ' + wsUrl);

            try {
                socket = io(wsUrl, {
                    auth: {
                        apiKey: apiKey
                    },
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    isConnected = true;
                    updateUI();
                    log('Connected successfully');
                });

                socket.on('disconnect', (reason) => {
                    isConnected = false;
                    updateUI();
                    log('Disconnected: ' + reason);
                });

                socket.on('connect_error', (error) => {
                    log('Connection error: ' + error.message, 'error');
                });

                socket.on('error', (error) => {
                    log('Socket error: ' + JSON.stringify(error), 'error');
                });

                // Listen for legacy order events (backward compatibility)
                socket.on('order:created', (order) => {
                    log('Legacy order created: ' + JSON.stringify(order, null, 2), 'received');
                });

                socket.on('order:updated', (update) => {
                    log('Legacy order updated: ' + JSON.stringify(update, null, 2), 'received');
                });

                // Listen for Lucrum events
                socket.on('sales-order:created', (order) => {
                    log('Sales order created: ' + JSON.stringify(order, null, 2), 'received');
                });

                socket.on('sales-order:status-updated', (update) => {
                    log('Sales order status updated: ' + JSON.stringify(update, null, 2), 'received');
                });

                socket.on('sales-order:kds-updated', (update) => {
                    log('Sales order KDS updated: ' + JSON.stringify(update, null, 2), 'received');
                });

                // Listen for KDS events
                socket.on('kds:new-order', (order) => {
                    log('KDS new order: ' + JSON.stringify(order, null, 2), 'received');
                });

                socket.on('kds:status-updated', (update) => {
                    log('KDS status updated: ' + JSON.stringify(update, null, 2), 'received');
                });

                socket.on('kds:cooking-started', (data) => {
                    log('Cooking started: ' + JSON.stringify(data, null, 2), 'received');
                });

                socket.on('kds:cooking-completed', (data) => {
                    log('Cooking completed: ' + JSON.stringify(data, null, 2), 'received');
                });

                socket.on('kds:order-ready', (data) => {
                    log('Order ready: ' + JSON.stringify(data, null, 2), 'received');
                });

                socket.on('pos:order-ready', (data) => {
                    log('POS notification - Order ready: ' + JSON.stringify(data, null, 2), 'received');
                });

                // Custom event listeners
                socket.onAny((eventName, ...args) => {
                    if (!['connect', 'disconnect', 'order:created', 'order:updated'].includes(eventName)) {
                        log(`Event '${eventName}': ${JSON.stringify(args)}`, 'event');
                    }
                });

            } catch (error) {
                log('Failed to create socket: ' + error.message, 'error');
            }
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                isConnected = false;
                updateUI();
                log('Disconnected manually');
            }
        }

        function sendOrderUpdate() {
            if (!socket || !isConnected) {
                alert('Not connected to WebSocket');
                return;
            }

            const orderId = document.getElementById('orderId').value;
            const status = document.getElementById('orderStatus').value;

            if (!orderId) {
                alert('Please enter Order ID');
                return;
            }

            const updateData = {
                order_id: orderId,
                status: status
            };

            log('Sending order status update: ' + JSON.stringify(updateData), 'sent');
            socket.emit('order:status', updateData);
        }

        function sendSalesOrder() {
            if (!socket || !isConnected) {
                alert('Not connected to WebSocket');
                return;
            }

            const salesOrderDataText = document.getElementById('salesOrderData').value;

            try {
                const salesOrderData = JSON.parse(salesOrderDataText);
                log('Sending Lucrum sales order: ' + JSON.stringify(salesOrderData, null, 2), 'sent');
                socket.emit('sales-order:new', salesOrderData);
            } catch (error) {
                alert('Invalid JSON in sales order data: ' + error.message);
                log('Invalid JSON: ' + error.message, 'error');
            }
        }

        function sendKDSUpdate() {
            if (!socket || !isConnected) {
                alert('Not connected to WebSocket');
                return;
            }

            const orderName = document.getElementById('kdsOrderName').value;
            const kdsStation = document.getElementById('kdsStation').value;
            const status = document.getElementById('kdsStatus').value;

            if (!orderName || !kdsStation) {
                alert('Please enter Order Name and KDS Station');
                return;
            }

            const updateData = {
                order_name: orderName,
                kds_station: kdsStation,
                status: status,
                timestamp: new Date().toISOString()
            };

            log('Sending KDS status update: ' + JSON.stringify(updateData, null, 2), 'sent');
            socket.emit('kds:status-update', updateData);
        }

        function sendNewOrder() {
            if (!socket || !isConnected) {
                alert('Not connected to WebSocket');
                return;
            }

            const orderDataText = document.getElementById('orderData').value;

            try {
                const orderData = JSON.parse(orderDataText);
                log('Sending new order: ' + JSON.stringify(orderData, null, 2), 'sent');
                socket.emit('order:new', orderData);
            } catch (error) {
                alert('Invalid JSON in order data: ' + error.message);
                log('Invalid JSON: ' + error.message, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Initialize UI
        updateUI();
        log('WebSocket test client initialized');
    </script>
</body>
</html>